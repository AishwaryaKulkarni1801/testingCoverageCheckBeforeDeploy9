name: Angular CI/CD with Coverage & ESLint Validation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

environment:
  name: github-pages

jobs:
  test-and-validate:
    name: ðŸ§ª Test & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run Jest tests with coverage
        run: npm run test -- --coverage --watchAll=false
        continue-on-error: true
        id: jest-tests

      - name: ðŸ“Š Parse coverage report
        if: steps.jest-tests.outcome == 'success'
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            TOTAL_COVERAGE=$(node -e "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const total = coverage.total;
              const lines = total.lines.pct;
              const statements = total.statements.pct;
              const functions = total.functions.pct;
              const branches = total.branches.pct;
              const average = (lines + statements + functions + branches) / 4;
              console.log(Math.round(average * 100) / 100);
            ")
            echo "COVERAGE_PERCENTAGE=$TOTAL_COVERAGE" >> $GITHUB_ENV
            echo "Coverage: $TOTAL_COVERAGE%"
            
            if (( $(echo "$TOTAL_COVERAGE < 80" | bc -l) )); then
              echo "âŒ Deployment stopped due to low test coverage (<80%)" >> $GITHUB_STEP_SUMMARY
              echo "Current coverage: $TOTAL_COVERAGE%" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… Test coverage check passed: $TOTAL_COVERAGE%" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Coverage report not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ðŸ” Run ESLint validation
        run: |
          echo "Running ESLint..."
          ESLINT_OUTPUT=$(npm run lint 2>&1) || ESLINT_EXIT_CODE=$?
          
          if [ $ESLINT_EXIT_CODE -ne 0 ]; then
            # Check if there are errors (not just warnings)
            if echo "$ESLINT_OUTPUT" | grep -q "error"; then
              echo "âŒ Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
              echo "ESLint found errors that must be fixed before deployment." >> $GITHUB_STEP_SUMMARY
              echo "Run 'npm run lint' locally to see detailed error information." >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âš ï¸ ESLint warnings found but continuing deployment" >> $GITHUB_STEP_SUMMARY
              echo "Consider fixing these warnings in future updates." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… ESLint validation passed with no errors or warnings" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/

  build-and-deploy:
    name: ðŸš€ Build & Deploy
    runs-on: ubuntu-latest
    needs: test-and-validate
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Detect Angular project name
        id: project-info
        run: |
          PROJECT_NAME=$(node -e "
            const fs = require('fs');
            const angular = JSON.parse(fs.readFileSync('angular.json', 'utf8'));
            const projectNames = Object.keys(angular.projects);
            console.log(projectNames[0]);
          ")
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_ENV
          echo "Angular project detected: $PROJECT_NAME"

      - name: ðŸ—ï¸ Build Angular application
        run: npm run build -- --base-href '/EsLint/'

      - name: ðŸ“ Setup GitHub Pages routing
        run: |
          # Get the actual output directory from build
          if [ -d "dist" ]; then
            DIST_DIR=$(ls dist/ | head -n 1)
            if [ -f "dist/$DIST_DIR/index.html" ]; then
              # Copy index.html to 404.html for SPA routing
              cp "dist/$DIST_DIR/index.html" "dist/$DIST_DIR/404.html"
              echo "âœ… Created 404.html for SPA routing"
              
              # Set output directory for GitHub Pages
              echo "DIST_PATH=dist/$DIST_DIR" >> $GITHUB_ENV
            else
              echo "âŒ Build output not found in expected location"
              exit 1
            fi
          else
            echo "âŒ Dist directory not found"
            exit 1
          fi

      - name: âš™ï¸ Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¤ Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.DIST_PATH }}

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-success:
    name: ðŸ“¢ Notify Success
    runs-on: ubuntu-latest
    needs: [test-and-validate, build-and-deploy]
    if: success()
    
    steps:
      - name: ðŸŽ‰ Deployment Success Notification
        run: |
          echo "### âœ… Deployment Successful ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **[View Site](https://AishwaryaKulkarni1801.github.io/EsLint/)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª All tests passed & ESLint validation cleared." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Jest tests completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Test coverage meets minimum threshold (â‰¥80%)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Angular build completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Pages deployment successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Your Angular application is now live!**" >> $GITHUB_STEP_SUMMARY
