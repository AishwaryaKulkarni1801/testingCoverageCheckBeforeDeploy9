name: CI/CD - Jest Coverage + ESLint Validation + GitHub Pages Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

environment:
  name: github-pages
  url: ${{ steps.deployment.outputs.page_url }}

jobs:
  test-and-validate:
    name: ğŸ§ª Test & Validate Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js LTS
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          
      - name: ğŸ“¦ Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run Jest tests with coverage
        run: npm run test:ci
        
      - name: ğŸ“Š Parse coverage report
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              Math.round(coverage.total.lines.pct);
            ")
            echo "Total coverage: $COVERAGE%"
            
            if [ "$COVERAGE" -lt 80 ]; then
              echo "### âŒ Deployment stopped due to low test coverage (<80%)" >> $GITHUB_STEP_SUMMARY
              echo "Current coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
              echo "Required coverage: 80%" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "### âœ… Coverage check passed: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Coverage report not found"
            exit 1
          fi
          
      - name: ğŸ” Run ESLint validation
        run: |
          echo "Running ESLint validation..."
          
          # Capture ESLint output
          if npm run lint > eslint-output.txt 2>&1; then
            echo "### âœ… ESLint validation passed" >> $GITHUB_STEP_SUMMARY
            if grep -q "warning" eslint-output.txt; then
              echo "âš ï¸ Warnings found but continuing deployment" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat eslint-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
      - name: ğŸ“‹ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test-and-validate
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js LTS
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          
      - name: ğŸ“¦ Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸ” Detect Angular project name
        id: project-info
        run: |
          PROJECT_NAME=$(node -p "
            const fs = require('fs');
            const angular = JSON.parse(fs.readFileSync('angular.json', 'utf8'));
            Object.keys(angular.projects)[0];
          ")
          OUTPUT_PATH=$(node -p "
            const fs = require('fs');
            const angular = JSON.parse(fs.readFileSync('angular.json', 'utf8'));
            const project = Object.keys(angular.projects)[0];
            angular.projects[project].architect.build.options.outputPath;
          ")
          echo "PROJECT_NAME=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_OUTPUT
          echo "Detected project: $PROJECT_NAME"
          echo "Output path: $OUTPUT_PATH"
          
      - name: ğŸ—ï¸ Build Angular project
        run: |
          npm run build -- --base-href '/testingCoverageCheckBeforeDeploy9/'
          echo "### ğŸ—ï¸ Build completed successfully" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ“„ Setup SPA routing (404.html)
        run: |
          OUTPUT_PATH="${{ steps.project-info.outputs.OUTPUT_PATH }}"
          if [ -f "$OUTPUT_PATH/index.html" ]; then
            cp "$OUTPUT_PATH/index.html" "$OUTPUT_PATH/404.html"
            echo "âœ… Created 404.html for SPA routing"
          else
            echo "âŒ index.html not found in $OUTPUT_PATH"
            exit 1
          fi
          
      - name: âš™ï¸ Setup GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.project-info.outputs.OUTPUT_PATH }}
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-success:
    name: ğŸ‰ Success Notification
    runs-on: ubuntu-latest
    needs: [test-and-validate, build-and-deploy]
    
    steps:
      - name: ğŸ“¢ Generate success summary
        run: |
          echo "### âœ… Deployment Successful ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **[View Site](https://AishwaryaKulkarni1801.github.io/testingCoverageCheckBeforeDeploy9/)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ§ª All tests passed & ESLint validation cleared." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Jest tests with coverage validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint code quality checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Angular build optimization" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SPA routing configuration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Pages deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Deployed on: $(date '+%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
