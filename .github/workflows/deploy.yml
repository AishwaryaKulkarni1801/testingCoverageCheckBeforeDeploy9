name: CI/CD Pipeline - Test, Build & Deploy Angular to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

environment:
  name: github-pages

jobs:
  test-and-validate:
    name: ðŸ§ª Test & Validate Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'
        
    - name: ðŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: ðŸ“¥ Install Dependencies
      run: npm ci
      
    - name: ðŸ§ª Run Jest Tests with Coverage
      run: npm run test -- --coverage --watchAll=false
      
    - name: ðŸ“Š Parse Coverage Report & Validate
      run: |
        if [ -f "coverage/coverage-summary.json" ]; then
          COVERAGE=$(node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const totalCoverage = coverage.total.lines.pct;
            console.log(totalCoverage);
          ")
          echo "Current test coverage: ${COVERAGE}%"
          
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "### âŒ Deployment stopped due to low test coverage (<80%)" >> $GITHUB_STEP_SUMMARY
            echo "Current coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            echo "Required coverage: 80%" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âœ… Test Coverage Passed" >> $GITHUB_STEP_SUMMARY
            echo "Current coverage: ${COVERAGE}% (â‰¥80%)" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### âŒ Coverage report not found" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
    - name: ðŸ” Run ESLint Validation
      run: |
        set +e  # Don't exit on error, we want to handle it ourselves
        npm run lint 2>&1 | tee eslint-output.txt
        ESLINT_EXIT_CODE=$?
        
        if [ $ESLINT_EXIT_CODE -ne 0 ]; then
          # Check if there are errors (not just warnings)
          if grep -q "error" eslint-output.txt; then
            echo "### âŒ Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the following ESLint errors before deploying:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "error" eslint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### âš ï¸ ESLint Warnings Found" >> $GITHUB_STEP_SUMMARY
            echo "Deployment will continue, but consider fixing these warnings:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat eslint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### âœ… ESLint Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "No ESLint errors or warnings found." >> $GITHUB_STEP_SUMMARY
        fi

  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test-and-validate
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸš€ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'
        
    - name: ðŸ“¦ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: ðŸ“¥ Install Dependencies
      run: npm ci
      
    - name: ðŸ” Detect Angular Project Name
      id: project-info
      run: |
        PROJECT_NAME=$(node -e "
          const fs = require('fs');
          const angular = JSON.parse(fs.readFileSync('angular.json', 'utf8'));
          const projectNames = Object.keys(angular.projects);
          console.log(projectNames[0]);
        ")
        echo "project-name=$PROJECT_NAME" >> $GITHUB_OUTPUT
        echo "Detected Angular project: $PROJECT_NAME"
        
    - name: ðŸ—ï¸ Build Angular Application
      run: npm run build -- --base-href '/EsLint/'
      
    - name: ðŸ“„ Copy index.html to 404.html for SPA Routing
      run: |
        # Find the dist directory
        DIST_DIR=$(find dist -name "index.html" -type f | head -1 | xargs dirname)
        if [ -f "$DIST_DIR/index.html" ]; then
          cp "$DIST_DIR/index.html" "$DIST_DIR/404.html"
          echo "âœ… Created 404.html for SPA routing"
        else
          echo "âŒ index.html not found in dist directory"
          exit 1
        fi
        
    - name: âš™ï¸ Configure GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ðŸ“¤ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'
        
    - name: ðŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify-success:
    name: ðŸŽ‰ Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [test-and-validate, build-and-deploy]
    
    steps:
    - name: ðŸŽŠ Generate Success Summary
      run: |
        echo "### âœ… Deployment Successful ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **[View Site](https://AishwaryaKulkarni1801.github.io/EsLint/)**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ§ª All tests passed & ESLint validation cleared." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Test Coverage: â‰¥80%" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ESLint: No errors found" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build: Successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Deploy: Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Deployed on: $(date)_" >> $GITHUB_STEP_SUMMARY
