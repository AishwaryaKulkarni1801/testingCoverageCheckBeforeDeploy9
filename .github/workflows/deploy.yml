name: CI/CD Pipeline with Jest Coverage, ESLint Validation & GitHub Pages Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

environment:
  name: github-pages
  url: ${{ steps.deployment.outputs.page_url }}

jobs:
  test-and-validate:
    name: ğŸ§ª Test & Validate Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ§ª Run Jest tests with coverage
        run: npm run test -- --coverage --watchAll=false
        
      - name: ğŸ“Š Parse coverage report and validate threshold
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "Math.round(JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct)")
            echo "ğŸ“Š Total Coverage: ${COVERAGE}%"
            
            if [ "$COVERAGE" -lt 80 ]; then
              echo "### âŒ Deployment stopped due to low test coverage (<80%)" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ”´ Current coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ¯ Required coverage: 80%" >> $GITHUB_STEP_SUMMARY
              echo "Please improve test coverage before deploying." >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… Coverage threshold met: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Coverage report not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
      - name: ğŸ” Run ESLint validation
        run: |
          echo "ğŸ” Running ESLint validation..."
          
          # Run ESLint and capture output
          if npm run lint 2>&1 | tee eslint-output.txt; then
            echo "âœ… ESLint validation passed" >> $GITHUB_STEP_SUMMARY
            
            # Check if there are warnings
            if grep -q "warning" eslint-output.txt; then
              echo "âš ï¸ ESLint warnings found (but continuing deployment)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”´ Please fix ESLint errors before deploying." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ESLint Output:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat eslint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
      - name: ğŸ“„ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

  build-and-deploy:
    name: ğŸš€ Build & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test-and-validate
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
            
      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ” Detect Angular project name
        id: project-info
        run: |
          # Extract project name from angular.json
          PROJECT_NAME=$(node -p "Object.keys(JSON.parse(require('fs').readFileSync('angular.json', 'utf8')).projects)[0]")
          echo "Detected Angular project: $PROJECT_NAME"
          echo "project-name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          
      - name: ğŸ—ï¸ Build Angular application
        run: |
          echo "ğŸ—ï¸ Building Angular application for GitHub Pages..."
          npm run build -- --base-href '/EsLint/'
          
      - name: ğŸ“„ Setup SPA routing (404.html)
        run: |
          # Determine the correct dist path
          if [ -d "dist/es-lint" ]; then
            DIST_PATH="dist/es-lint"
          elif [ -d "dist/testing-coverage-check-before-deploy9" ]; then
            DIST_PATH="dist/testing-coverage-check-before-deploy9"
          else
            # Find the first directory in dist/
            DIST_PATH=$(find dist -maxdepth 1 -type d ! -name dist | head -1)
          fi
          
          echo "Using dist path: $DIST_PATH"
          
          if [ -f "$DIST_PATH/index.html" ]; then
            cp "$DIST_PATH/index.html" "$DIST_PATH/404.html"
            echo "âœ… Created 404.html for SPA routing"
          else
            echo "âŒ index.html not found in $DIST_PATH"
            exit 1
          fi
          
          # Store dist path for next step
          echo "dist-path=$DIST_PATH" >> $GITHUB_ENV
          
      - name: âš™ï¸ Setup GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¤ Upload artifact to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.dist-path }}
          
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-success:
    name: ğŸ‰ Deployment Success Notification
    runs-on: ubuntu-latest
    needs: [test-and-validate, build-and-deploy]
    if: success()
    
    steps:
      - name: ğŸ‰ Generate success summary
        run: |
          echo "### âœ… Deployment Successful ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **[View Live Site](https://AishwaryaKulkarni1801.github.io/EsLint/)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ§ª **All tests passed & ESLint validation cleared.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Jest tests: Passed with >80% coverage" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint validation: No errors found" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Angular build: Successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Pages: Deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ **Your Angular application is now live!**" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ“¢ Post deployment info
        run: |
          echo "ğŸŠ Deployment completed successfully!"
          echo "ğŸ“± Site URL: https://AishwaryaKulkarni1801.github.io/EsLint/"
          echo "ğŸ“ Check the Actions Summary tab for detailed results."
