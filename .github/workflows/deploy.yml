name: CI/CD Pipeline - Angular with Jest Coverage & ESLint + GitHub Pages Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

environment:
  name: github-pages

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test & Validate
    outputs:
      coverage-passed: ${{ steps.coverage-check.outputs.passed }}
      eslint-passed: ${{ steps.eslint-check.outputs.passed }}
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
      
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ§ª Run Jest tests with coverage
        run: npm run test -- --coverage --watchAll=false
      
      - name: ğŸ“Š Parse coverage report
        id: coverage-check
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "
              const coverage = require('./coverage/coverage-summary.json');
              const total = coverage.total;
              Math.min(
                total.lines.pct,
                total.statements.pct,
                total.functions.pct,
                total.branches.pct
              );
            ")
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "âŒ Deployment stopped due to low test coverage (<80%)" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“Š Current coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
              echo "passed=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "âœ… Coverage check passed: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
              echo "passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Coverage report not found!" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ğŸ” Run ESLint
        id: eslint-check
        run: |
          if npm run lint 2>&1 | tee eslint-output.txt; then
            if grep -q "error" eslint-output.txt; then
              echo "âŒ Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
              echo "passed=false" >> $GITHUB_OUTPUT
              cat eslint-output.txt >> $GITHUB_STEP_SUMMARY
              exit 1
            elif grep -q "warning" eslint-output.txt; then
              echo "âš ï¸ ESLint warnings found but continuing deployment" >> $GITHUB_STEP_SUMMARY
              echo "passed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… ESLint validation passed - no errors or warnings" >> $GITHUB_STEP_SUMMARY
              echo "passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Deployment stopped due to ESLint errors" >> $GITHUB_STEP_SUMMARY
            echo "passed=false" >> $GITHUB_OUTPUT
            cat eslint-output.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  build-and-deploy:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build & Deploy
    needs: test-and-validate
    if: needs.test-and-validate.outputs.coverage-passed == 'true' && needs.test-and-validate.outputs.eslint-passed == 'true'
    
    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
      
      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: ğŸ“¥ Install dependencies
        run: npm ci
      
      - name: ğŸ” Detect Angular project name
        id: project-info
        run: |
          PROJECT_NAME=$(node -p "require('./angular.json').projects[Object.keys(require('./angular.json').projects)[0]].architect.build.options.outputPath.split('/').pop()")
          echo "project-name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "Detected project name: $PROJECT_NAME"
      
      - name: ğŸ—ï¸ Build Angular project
        run: npm run build -- --base-href '/EsLint/'
      
      - name: ğŸ“„ Copy index.html to 404.html for SPA routing
        run: |
          if [ -d "dist" ]; then
            DIST_DIR=$(find dist -maxdepth 1 -type d | tail -n 1)
            if [ -f "$DIST_DIR/index.html" ]; then
              cp "$DIST_DIR/index.html" "$DIST_DIR/404.html"
              echo "âœ… Created 404.html for SPA routing"
            else
              echo "âŒ index.html not found in $DIST_DIR"
              exit 1
            fi
          else
            echo "âŒ dist directory not found"
            exit 1
          fi
      
      - name: âš™ï¸ Configure GitHub Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“¤ Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
      
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify-success:
    runs-on: ubuntu-latest
    name: ğŸ‰ Notify Success
    needs: [test-and-validate, build-and-deploy]
    if: success()
    
    steps:
      - name: ğŸ‰ Success notification
        run: |
          echo "### âœ… Deployment Successful ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **[View Site](https://AishwaryaKulkarni1801.github.io/EsLint/)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ§ª All tests passed & ESLint validation cleared." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Jest tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Coverage check: Passed (â‰¥80%)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ESLint validation: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Angular build: Success" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Pages deployment: Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ **Site is now live!**" >> $GITHUB_STEP_SUMMARY